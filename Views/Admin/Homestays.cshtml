@using WebHSPromotionType = WebHS.Models.PromotionType
@model WebHS.ViewModels.AdminHomestayListViewModel

@{
    ViewData["Title"] = "Quản Lý Homestay";
    Layout = "~/Views/Shared/_Layout_New.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Quản Lý Homestay</h3>
                    <div class="card-tools">
                        <div class="btn-group">
                            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                Trạng thái: @(ViewBag.Status ?? "Tất cả")
                            </button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="?status=">Tất cả</a>
                                <a class="dropdown-item" href="?status=pending">Chờ duyệt</a>
                                <a class="dropdown-item" href="?status=approved">Đã duyệt</a>
                                <a class="dropdown-item" href="?status=rejected">Đã từ chối</a>
                                <a class="dropdown-item" href="?status=inactive">Không hoạt động</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-body table-responsive p-0">
                    <table class="table table-hover text-nowrap">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Hình ảnh</th>
                                <th>Tên Homestay</th>
                                <th>Chủ nhà</th>
                                <th>Địa điểm</th>
                                <th>Giá/đêm</th>
                                <th>Trạng thái</th>
                                <th>Ngày tạo</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach(var homestay in Model.Homestays)
                            {
                                <tr>
                                    <td>@homestay.Id</td>
                                    <td>
                                        @if(homestay.Images.Any())
                                        {
                                            <img src="@homestay.Images.First().ImageUrl" alt="@homestay.Name" style="width: 60px; height: 40px; object-fit: cover;">
                                        }
                                        else
                                        {
                                            <div class="bg-secondary d-flex align-items-center justify-content-center" style="width: 60px; height: 40px;">
                                                <i class="fas fa-home"></i>
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        <strong>@homestay.Name</strong><br>
                                        <small class="text-muted">@homestay.MaxGuests khách • @homestay.Bedrooms phòng ngủ</small>
                                    </td>
                                    <td>
                                        <strong>@homestay.Host.FirstName @homestay.Host.LastName</strong><br>
                                        <small class="text-muted">@homestay.Host.Email</small>
                                    </td>
                                    <td>@homestay.City, @homestay.State</td>
                                    <td>@homestay.PricePerNight.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("vi-VN"))</td>
                                    <td>
                                        @if(homestay.IsApproved && homestay.IsActive)
                                        {
                                            <span class="badge bg-success text-white">Đã duyệt</span>
                                        }
                                        else if(!homestay.IsApproved && homestay.IsActive)
                                        {
                                            <span class="badge bg-warning text-dark">Chờ duyệt</span>
                                        }
                                        else if(!homestay.IsActive)
                                        {
                                            <span class="badge bg-secondary text-white">Không hoạt động</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger text-white">Đã từ chối</span>
                                        }
                                    </td>
                                    <td>@homestay.CreatedAt.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="@Url.Action("Details", "Homestay", new { id = homestay.Id })" class="btn btn-info btn-sm" target="_blank">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            
                                            @if(!homestay.IsApproved && homestay.IsActive)
                                            {
                                                <button type="button" class="btn btn-success btn-sm" onclick="approveHomestay(@homestay.Id)">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn btn-danger btn-sm" onclick="rejectHomestay(@homestay.Id)">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            }
                                            
                                            @if(homestay.IsActive)
                                            {
                                                <button type="button" class="btn btn-warning btn-sm" onclick="deactivateHomestay(@homestay.Id)">
                                                    <i class="fas fa-ban"></i>
                                                </button>
                                            }
                                            else
                                            {
                                                <button type="button" class="btn btn-success btn-sm" onclick="activateHomestay(@homestay.Id)">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="card-footer clearfix">
                    <ul class="pagination pagination-sm m-0 float-right">
                        @if(Model.CurrentPage > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" href="?page=@(Model.CurrentPage - 1)&status=@ViewBag.Status">«</a>
                            </li>
                        }

                        @for(int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                        {
                            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                <a class="page-link" href="?page=@i&status=@ViewBag.Status">@i</a>
                            </li>
                        }

                        @if(Model.CurrentPage < Model.TotalPages)
                        {
                            <li class="page-item">
                                <a class="page-link" href="?page=@(Model.CurrentPage + 1)&status=@ViewBag.Status">»</a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rejection Reason Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Lý do từ chối</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="rejectForm">
                    <input type="hidden" id="rejectHomestayId" name="homestayId">
                    <div class="form-group">
                        <label for="rejectReason">Lý do từ chối *</label>
                        <textarea class="form-control" id="rejectReason" name="reason" rows="4" required placeholder="Vui lòng nhập lý do từ chối..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" onclick="submitReject()">Từ chối</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function approveHomestay(id) {
            if (confirm('Bạn có chắc chắn muốn duyệt homestay này?')) {
                $.post('@Url.Action("ApproveHomestay")', { id: id }, function(data) {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Có lỗi xảy ra: ' + data.message);
                    }
                });
            }
        }

        function rejectHomestay(id) {
            $('#rejectHomestayId').val(id);
            $('#rejectReason').val('');
            $('#rejectModal').modal('show');
        }

        function submitReject() {
            var id = $('#rejectHomestayId').val();
            var reason = $('#rejectReason').val();
            
            if (!reason.trim()) {
                alert('Vui lòng nhập lý do từ chối');
                return;
            }

            $.post('@Url.Action("RejectHomestay")', { id: id, reason: reason }, function(data) {
                if (data.success) {
                    $('#rejectModal').modal('hide');
                    location.reload();
                } else {
                    alert('Có lỗi xảy ra: ' + data.message);
                }
            });
        }

        function deactivateHomestay(id) {
            if (confirm('Bạn có chắc chắn muốn vô hiệu hóa homestay này?')) {
                $.post('@Url.Action("DeactivateHomestay")', { id: id }, function(data) {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Có lỗi xảy ra: ' + data.message);
                    }
                });
            }
        }

        function activateHomestay(id) {
            if (confirm('Bạn có chắc chắn muốn kích hoạt lại homestay này?')) {
                $.post('@Url.Action("ActivateHomestay")', { id: id }, function(data) {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Có lỗi xảy ra: ' + data.message);
                    }
                });
            }
        }
    </script>
}

